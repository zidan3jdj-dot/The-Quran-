<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القرآن الكريم - المصحف الأخضر</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ===== المتغيرات ===== */
        :root {
            --dark-green: #0a3b2e;
            --medium-green: #1d5e45;
            --light-green: #2a6b4e;
            --gold: #c4a55b;
            --light-gold: #e6d5a8;
            --paper: #fef9e7;
            --font-size-base: 32px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Amiri Quran', serif;
            background: var(--dark-green);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M20 20 L30 10 L40 20 L50 5 L60 20 L70 8 L80 20 L85 15 L90 20 L82 35 L90 50 L80 60 L70 50 L60 70 L50 55 L40 70 L30 55 L20 70 L10 50 L20 35 L10 20 L20 20" fill="none" stroke="%23e6d5a8" stroke-width="1.5"/><circle cx="50" cy="30" r="2" fill="%23e6d5a8"/><circle cx="30" cy="50" r="2" fill="%23e6d5a8"/><circle cx="70" cy="50" r="2" fill="%23e6d5a8"/></svg>');
            background-repeat: repeat;
            min-height: 100vh;
            padding-bottom: 140px;
            color: #f9f3d9;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 59, 46, 0.85);
            z-index: -1;
        }

        /* ===== الهيدر ===== */
        header {
            text-align: center;
            padding: 30px 20px;
            font-size: 42px;
            color: var(--light-gold);
            text-shadow: 0 0 15px var(--light-green), 2px 2px 0 #1d4a38;
            background: linear-gradient(180deg, var(--medium-green), transparent);
            border-bottom: 3px solid var(--gold);
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        /* ===== البحث ===== */
        .search-box {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            border: 2px solid var(--light-green);
            border-radius: 60px;
            padding: 5px 20px;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0,20,10,0.6);
        }

        .search-box i {
            font-size: 24px;
            color: var(--gold);
            margin-left: 15px;
        }

        .search-box input {
            background: transparent;
            border: none;
            width: 100%;
            padding: 15px 0;
            font-size: 22px;
            color: #f9f3d9;
            outline: none;
            font-family: 'Amiri Quran', serif;
        }

        .search-box input::placeholder {
            color: #a1c9b6;
            opacity: 0.8;
        }

        /* ===== فهرس السور ===== */
        .list-header {
            text-align: center;
            margin: 40px 0 25px;
        }

        .list-header h2 {
            font-size: 36px;
            color: var(--light-gold);
            background: rgba(26,78,58,0.7);
            display: inline-block;
            padding: 10px 40px;
            border-radius: 80px;
            border: 2px solid var(--gold);
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px #1a3b2c;
        }

        #surahList {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .surah-card {
            background: rgba(26,68,50,0.7);
            backdrop-filter: blur(8px);
            border: 2px solid var(--light-green);
            color: #f3e8c2;
            padding: 20px 25px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.4s;
            box-shadow: 0 8px 20px rgba(0,20,0,0.6);
            border-bottom: 4px solid var(--gold);
        }

        .surah-card:hover {
            transform: translateY(-5px) scale(1.01);
            background: rgba(36,94,70,0.9);
            border-color: var(--light-gold);
            box-shadow: 0 15px 35px #1a4a33;
        }

        .surah-name {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .surah-name i { color: var(--gold); font-size: 28px; }

        .surah-number {
            background: var(--light-green);
            color: var(--light-gold);
            min-width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-size: 22px; font-weight: bold;
            border: 2px solid var(--gold);
            box-shadow: 0 0 0 2px #1d4a38;
            padding: 0 5px;
        }

        .surah-meta {
            display: flex; align-items: center; gap: 15px;
        }

        .ayah-count {
            background: #1d4a38; color: var(--light-gold);
            padding: 5px 15px; border-radius: 30px;
            font-size: 18px; border: 1px solid var(--gold);
        }

        /* ===== شريط اختيار القارئ المتطور ===== */
        .reader-header {
            background: rgba(26,68,50,0.8);
            backdrop-filter: blur(12px);
            padding: 15px 25px;
            border-radius: 80px;
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            position: relative;
        }

        .back, .share-btn {
            background: var(--light-green);
            border: 2px solid var(--gold);
            padding: 12px 20px;
            border-radius: 50px;
            color: #f3e8c2;
            cursor: pointer;
            font-size: 22px;
            transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }

        .share-btn { background: #1d4a38; }

        .back:hover, .share-btn:hover {
            background: var(--medium-green);
            transform: translateX(-5px);
        }

        /* القارئ الحالي */
        .current-reciter {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.2);
            padding: 8px 20px;
            border-radius: 60px;
            cursor: pointer;
            border: 1px solid var(--gold);
            transition: 0.3s;
        }

        .current-reciter:hover {
            background: rgba(0,0,0,0.4);
        }

        .reciter-img {
            width: 50px; height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gold);
        }

        .reciter-name {
            font-size: 24px;
            color: var(--light-gold);
        }

        .current-reciter i {
            margin-right: auto;
            color: var(--gold);
            font-size: 20px;
        }

        /* القائمة المنسدلة */
        .reciter-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            margin-top: 10px;
            background: rgba(26,58,46,0.98);
            backdrop-filter: blur(10px);
            border: 2px solid var(--gold);
            border-radius: 40px;
            padding: 15px;
            z-index: 100;
            display: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .reciter-dropdown.show {
            display: block;
        }

        .reciter-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 60px;
            transition: 0.3s;
            cursor: pointer;
            border-bottom: 1px solid var(--light-green);
        }

        .reciter-option:last-child {
            border-bottom: none;
        }

        .reciter-option:hover {
            background: var(--light-green);
        }

        .reciter-option img {
            width: 45px; height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold);
        }

        .reciter-option span {
            font-size: 22px;
            color: var(--light-gold);
        }

        /* ===== رأس السورة ===== */
        .surah-info {
            text-align: center;
            color: var(--light-gold);
            font-size: 40px;
            margin: 10px 0 5px;
            text-shadow: 0 0 10px #1a4a33;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .surah-stats {
            font-size: 22px;
            background: rgba(0,0,0,0.3);
            padding: 5px 20px;
            border-radius: 40px;
            border: 1px solid var(--gold);
        }

        .font-controls {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        .font-controls button {
            background: var(--light-green);
            border: 2px solid var(--gold);
            color: var(--light-gold);
            width: 45px; height: 45px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }

        .font-controls button:hover {
            background: var(--medium-green);
            transform: scale(1.1);
        }

        /* ===== المصحف ===== */
        .mushaf {
            background: var(--paper);
            padding: 50px 30px;
            border-radius: 50px 50px 30px 30px;
            line-height: 3;
            font-size: var(--font-size-base);
            text-align: center;
            box-shadow: 0 0 0 8px var(--light-green), 0 0 0 15px var(--gold), 0 25px 50px rgba(0,30,10,0.8);
            color: #1d3b2c;
            position: relative;
            margin-top: 25px;
            transition: font-size 0.2s;
        }

        .mushaf::before {
            content: "﴿"; font-size: 70px; color: var(--light-green);
            position: absolute; top: -25px; right: 30px; opacity: 0.5; transform: rotate(10deg);
        }

        .mushaf::after {
            content: "﴾"; font-size: 70px; color: var(--light-green);
            position: absolute; bottom: -25px; left: 30px; opacity: 0.5; transform: rotate(-10deg);
        }

        .bismillah {
            font-size: 45px;
            color: var(--light-green);
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 0 0 5px var(--gold);
            border-bottom: 2px dashed var(--gold);
            padding-bottom: 15px;
        }

        .ayah {
            padding: 6px 12px;
            border-radius: 25px;
            transition: 0.3s;
            cursor: pointer;
            display: inline-block;
            margin: 2px 0;
            position: relative;
        }

        .ayah:hover {
            background: rgba(42,107,78,0.2);
        }

        .ayah[data-ayah-number]:hover::after {
            content: attr(data-ayah-number);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1d4a38; color: var(--light-gold);
            font-size: 16px; padding: 4px 8px; border-radius: 20px;
            white-space: nowrap; border: 1px solid var(--gold); margin-bottom: 5px; z-index: 10;
        }

        .active {
            background: linear-gradient(145deg, var(--gold), var(--light-green));
            color: var(--paper);
            box-shadow: 0 0 25px var(--gold), 0 5px 15px #1d4a38;
            transform: scale(1.02);
            font-weight: bold;
            border-radius: 35px;
            padding: 6px 20px;
        }

        /* ===== المشغل ===== */
        .player {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 750px;
            background: rgba(10,45,35,0.98);
            backdrop-filter: blur(15px);
            border: 3px solid var(--gold);
            border-radius: 100px;
            padding: 15px 25px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 20px 45px #0a251d, 0 0 0 3px var(--light-green) inset;
            z-index: 1000;
            transition: 0.4s;
        }

        .player.hidden {
            opacity: 0; visibility: hidden; transform: translateX(-50%) translateY(30px);
        }

        .player button {
            background: linear-gradient(145deg, var(--gold), var(--light-green));
            border: none; width: 60px; height: 60px; border-radius: 50%;
            font-size: 28px; cursor: pointer; transition: 0.3s;
            color: #1d3b2c; box-shadow: 0 5px 0 #1a4a33, 0 10px 20px black;
            display: flex; align-items: center; justify-content: center;
        }

        .player button:hover:not(:disabled) {
            transform: translateY(-3px); box-shadow: 0 8px 0 #1a4a33, 0 15px 25px black;
        }

        .player button:active:not(:disabled) {
            transform: translateY(4px); box-shadow: 0 2px 0 #1a4a33, 0 10px 20px black;
        }

        .player button:disabled {
            opacity: 0.4; cursor: not-allowed; box-shadow: 0 4px 0 #1a4a33;
        }

        .progress-area {
            flex: 1;
            display: flex; align-items: center; gap: 10px;
        }

        .progress-bar {
            flex: 1; height: 8px; background: #1d4a38; border-radius: 10px; overflow: hidden;
        }

        .progress-fill {
            height: 100%; width: 0%; background: var(--gold); border-radius: 10px;
        }

        .ayah-counter {
            color: var(--light-gold); font-size: 18px; min-width: 80px; text-align: center;
        }

        /* ===== أزرار مساعدة ===== */
        .go-top {
            position: fixed; bottom: 120px; left: 20px;
            background: var(--light-green); color: var(--light-gold);
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; border: 3px solid var(--gold);
            box-shadow: 0 5px 15px black; transition: 0.3s;
            opacity: 0; visibility: hidden; z-index: 999;
        }

        .go-top.show { opacity: 1; visibility: visible; }
        .go-top:hover { background: var(--medium-green); transform: scale(1.1); }

        .notification {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: #1d4a38; color: var(--light-gold);
            padding: 15px 30px; border-radius: 60px; border: 3px solid var(--gold);
            font-size: 20px; z-index: 2000; display: none; backdrop-filter: blur(5px);
        }

        .loader, .error {
            text-align: center; padding: 40px; font-size: 28px;
            background: rgba(0,0,0,0.3); border-radius: 50px; margin: 30px 0;
        }
        .loader { color: var(--light-gold); }
        .loader i { animation: spin 2s infinite linear; margin-left: 10px; }
        .error { color: #ffaa7a; border: 3px solid #c47a5b; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .islamic-pattern {
            height: 15px; background: repeating-linear-gradient(45deg, var(--gold) 0px, var(--gold) 10px, var(--light-green) 10px, var(--light-green) 20px);
            border-radius: 10px; margin: 20px 0;
        }

        @media (max-width: 700px) {
            header { font-size: 34px; }
            .surah-name { font-size: 22px; }
            .surah-number { min-width: 40px; height: 40px; font-size: 18px; }
            .mushaf { font-size: 26px; padding: 30px 15px; }
            .player button { width: 50px; height: 50px; font-size: 24px; }
            .reciter-name { font-size: 20px; }
        }
    </style>
</head>
<body>
    <header><i class="fas fa-mosque"></i> القرآن الكريم <i class="fas fa-star"></i></header>

    <div class="container">
        <!-- الصفحة الرئيسية -->
        <div id="home">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن سورة...">
            </div>
            <div class="list-header"><h2><i class="fas fa-list"></i> فهرس السور</h2></div>
            <div id="surahList"></div>
        </div>

        <!-- صفحة عرض السورة -->
        <div id="reader" style="display: none;">
            <div class="reader-header">
                <button class="back" onclick="goHome()"><i class="fas fa-arrow-right"></i> العودة</button>
                
                <!-- القارئ الحالي مع القائمة المنسدلة -->
                <div class="current-reciter" id="currentReciterBtn" onclick="toggleReciterDropdown()">
                    <img id="currentReciterImg" src="1.jpeg" alt="reciter" class="reciter-img" onerror="this.src='https://via.placeholder.com/50?text=?'">
                    <span id="currentReciterName" class="reciter-name">مشاري العفاسي</span>
                    <i class="fas fa-chevron-down"></i>
                </div>

                <!-- قائمة القراء المخفية -->
                <div id="reciterDropdown" class="reciter-dropdown">
                    <div class="reciter-option" data-value="ar.alafasy" data-img="1.jpeg" onclick="selectReciter('ar.alafasy', 'مشاري العفاسي', '1.jpeg')">
                        <img src="1.jpeg" onerror="this.src='https://via.placeholder.com/45?text=?'">
                        <span>مشاري العفاسي</span>
                    </div>
                    <div class="reciter-option" data-value="ar.abdulbasitmurattal" data-img="2.jpeg" onclick="selectReciter('ar.abdulbasitmurattal', 'عبد الباسط عبد الصمد', '2.jpeg')">
                        <img src="2.jpeg" onerror="this.src='https://via.placeholder.com/45?text=?'">
                        <span>عبد الباسط عبد الصمد</span>
                    </div>
                    <div class="reciter-option" data-value="ar.mahermuaiqly" data-img="3.jpeg" onclick="selectReciter('ar.mahermuaiqly', 'ماهر المعيقلي', '3.jpeg')">
                        <img src="3.jpeg" onerror="this.src='https://via.placeholder.com/45?text=?'">
                        <span>ماهر المعيقلي</span>
                    </div>
                    <div class="reciter-option" data-value="ar.minshawi" data-img="4.jpeg" onclick="selectReciter('ar.minshawi', 'محمد صديق المنشاوي', '4.jpeg')">
                        <img src="4.jpeg" onerror="this.src='https://via.placeholder.com/45?text=?'">
                        <span>محمد صديق المنشاوي</span>
                    </div>
                </div>

                <button class="share-btn" id="shareBtn" onclick="shareSurah()"><i class="fas fa-share-alt"></i> مشاركة</button>
            </div>

            <!-- رأس السورة مع أدوات التحكم -->
            <div class="surah-info" id="surahName">
                <span><i class="fas fa-quran"></i> سورة الفاتحة</span>
                <span class="surah-stats" id="surahStats">7 آيات</span>
                <div class="font-controls">
                    <button onclick="changeFontSize(2)"><i class="fas fa-plus"></i></button>
                    <button onclick="changeFontSize(-2)"><i class="fas fa-minus"></i></button>
                </div>
            </div>

            <div class="islamic-pattern"></div>

            <div class="mushaf" id="ayahContainer" style="font-size: var(--font-size-base);">
                <div class="loader"><i class="fas fa-spinner fa-spin"></i> جاري تحميل السورة...</div>
            </div>
        </div>
    </div>

    <!-- مشغل الصوت المتطور -->
    <div class="player" id="player">
        <button onclick="prevAyah()" id="prevBtn" title="الآية السابقة"><i class="fas fa-step-backward"></i></button>
        <button onclick="togglePlay()" id="playPauseBtn" title="تشغيل/إيقاف"><i class="fas fa-play"></i></button>
        <button onclick="nextAyah()" id="nextBtn" title="الآية التالية"><i class="fas fa-step-forward"></i></button>
        <div class="progress-area">
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
            <span class="ayah-counter" id="ayahCounter">0/0</span>
        </div>
        <audio id="audio" preload="auto"></audio>
    </div>

    <!-- زر العودة للأعلى -->
    <div class="go-top" id="goTop" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fas fa-arrow-up"></i></div>

    <!-- إشعارات -->
    <div class="notification" id="notification"></div>

    <script>
        // ========== الثوابت والمتغيرات ==========
        const API = "https://api.alquran.cloud/v1";
        let allSurahs = [], ayahs = [], currentIndex = 0, currentSurahNumber = null, isPlaying = false;
        let currentReciter = localStorage.getItem('reciter') || 'ar.alafasy';
        let currentReciterName = localStorage.getItem('reciterName') || 'مشاري العفاسي';
        let currentReciterImg = localStorage.getItem('reciterImg') || '1.jpeg';
        let fontSize = parseInt(localStorage.getItem('fontSize')) || 32;

        // عناصر DOM
        const homeDiv = document.getElementById('home');
        const readerDiv = document.getElementById('reader');
        const surahListDiv = document.getElementById('surahList');
        const ayahContainer = document.getElementById('ayahContainer');
        const audio = document.getElementById('audio');
        const playerDiv = document.getElementById('player');
        const surahNameDiv = document.getElementById('surahName');
        const surahStats = document.getElementById('surahStats');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const searchInput = document.getElementById('searchInput');
        const goTopBtn = document.getElementById('goTop');
        const notification = document.getElementById('notification');
        const ayahCounter = document.getElementById('ayahCounter');
        const progressFill = document.getElementById('progressFill');

        // عناصر القارئ
        const currentReciterImgEl = document.getElementById('currentReciterImg');
        const currentReciterNameEl = document.getElementById('currentReciterName');
        const reciterDropdown = document.getElementById('reciterDropdown');

        // تعيين القارئ المحفوظ
        currentReciterImgEl.src = currentReciterImg;
        currentReciterNameEl.textContent = currentReciterName;

        // ========== تحميل السور ==========
        async function loadSurahs() {
            try {
                surahListDiv.innerHTML = '<div class="loader"><i class="fas fa-spinner fa-spin"></i> جاري تحميل القائمة...</div>';
                const res = await fetch(`${API}/surah`);
                if (!res.ok) throw new Error('فشل الاتصال');
                const data = await res.json();
                allSurahs = data.data;
                displaySurahs(allSurahs);
                const lastSurah = localStorage.getItem('lastSurah');
                if (lastSurah) {
                    const { number, name } = JSON.parse(lastSurah);
                    setTimeout(() => openSurah(number, name), 500);
                }
            } catch (e) {
                surahListDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${e.message}</div>`;
            }
        }

        function displaySurahs(surahs) {
            surahListDiv.innerHTML = '';
            if (!surahs.length) {
                surahListDiv.innerHTML = '<div class="error">لا توجد نتائج</div>';
                return;
            }
            surahs.forEach(s => {
                const card = document.createElement('div');
                card.className = 'surah-card';
                card.innerHTML = `
                    <div class="surah-name"><i class="fas fa-quran"></i> ${s.name} (${s.englishName})</div>
                    <div class="surah-meta"><span class="ayah-count">${s.numberOfAyahs} آية</span><span class="surah-number">${s.number}</span></div>
                `;
                card.onclick = () => openSurah(s.number, s.name);
                surahListDiv.appendChild(card);
            });
        }

        // ========== فتح السورة ==========
        async function openSurah(number, name) {
            try {
                localStorage.setItem('lastSurah', JSON.stringify({ number, name }));
                homeDiv.style.display = 'none';
                readerDiv.style.display = 'block';
                surahNameDiv.querySelector('span:first-child').innerHTML = `<i class="fas fa-quran"></i> سورة ${name}`;
                ayahContainer.innerHTML = '<div class="loader"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';
                playerDiv.classList.add('hidden');

                const res = await fetch(`${API}/surah/${number}/quran-uthmani`);
                if (!res.ok) throw new Error('فشل التحميل');
                const data = await res.json();
                ayahs = data.data.ayahs;
                currentSurahNumber = number;
                currentIndex = 0;

                // عرض عدد الآيات
                surahStats.textContent = `${ayahs.length} آيات`;

                renderAyahs();
                playerDiv.classList.remove('hidden');
                updateButtonsState();
                updateCounter();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                ayahContainer.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> ${e.message}</div>`;
            }
        }

        function renderAyahs() {
            ayahContainer.innerHTML = '';
            if (currentSurahNumber !== 9) {
                const b = document.createElement('div');
                b.className = 'bismillah';
                b.textContent = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
                ayahContainer.appendChild(b);
            }
            ayahs.forEach((a, i) => {
                const span = document.createElement('span');
                span.className = 'ayah';
                span.id = `ayah-${i}`;
                span.textContent = a.text + ' ۝ ';
                span.setAttribute('data-ayah-number', `الآية ${a.numberInSurah}`);
                span.onclick = () => copyAyah(a.text, i);
                ayahContainer.appendChild(span);
            });
            if (ayahs.length) highlightAyah();
        }

        // ========== النسخ والإشعارات ==========
        function copyAyah(text, index) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('تم نسخ الآية');
                playAyah(index);
            }).catch(() => showNotification('تعذر النسخ', true));
        }

        function showNotification(msg, isError = false) {
            notification.textContent = msg;
            notification.style.backgroundColor = isError ? '#8b3a3a' : '#1d4a38';
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 2000);
        }

        // ========== قائمة القراء ==========
        window.toggleReciterDropdown = function() {
            reciterDropdown.classList.toggle('show');
        };

        window.selectReciter = function(value, name, img) {
            currentReciter = value;
            currentReciterName = name;
            currentReciterImg = img;
            localStorage.setItem('reciter', value);
            localStorage.setItem('reciterName', name);
            localStorage.setItem('reciterImg', img);
            currentReciterImgEl.src = img;
            currentReciterNameEl.textContent = name;
            reciterDropdown.classList.remove('show');
            if (!audio.paused) {
                audio.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            }
            audio.src = ''; // إعادة تعيين المصدر
        };

        // إغلاق القائمة عند النقر خارجها
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.current-reciter') && !e.target.closest('.reciter-dropdown')) {
                reciterDropdown.classList.remove('show');
            }
        });

        // ========== مشغل الصوت ==========
        async function playAyah(index) {
            if (index < 0 || index >= ayahs.length) return;
            currentIndex = index;
            highlightAyah();
            try {
                playPauseBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i>';
                const ayahNumber = ayahs[index].number;
                const res = await fetch(`${API}/ayah/${ayahNumber}/${currentReciter}`);
                if (!res.ok) throw new Error('فشل تحميل الصوت');
                const data = await res.json();
                audio.src = data.data.audio;
                await audio.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                audio.onended = () => {
                    if (currentIndex < ayahs.length - 1) {
                        playAyah(currentIndex + 1);
                    } else {
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        isPlaying = false;
                    }
                };
            } catch (e) {
                showNotification('تعذر تشغيل الصوت', true);
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            }
        }

        function highlightAyah() {
            document.querySelectorAll('.ayah').forEach(a => a.classList.remove('active'));
            const current = document.getElementById(`ayah-${currentIndex}`);
            if (current) {
                current.classList.add('active');
                current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            updateButtonsState();
            updateCounter();
        }

        function updateButtonsState() {
            if (!ayahs.length) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === ayahs.length - 1;
        }

        function updateCounter() {
            if (ayahs.length) {
                ayahCounter.textContent = `${currentIndex + 1}/${ayahs.length}`;
                progressFill.style.width = `${((currentIndex + 1) / ayahs.length) * 100}%`;
            } else {
                ayahCounter.textContent = '0/0';
                progressFill.style.width = '0%';
            }
        }

        window.togglePlay = function() {
            if (!ayahs.length) return;
            if (audio.paused) {
                if (!audio.src) playAyah(currentIndex);
                else audio.play();
            } else {
                audio.pause();
            }
        };

        window.nextAyah = function() {
            if (currentIndex < ayahs.length - 1) playAyah(currentIndex + 1);
        };

        window.prevAyah = function() {
            if (currentIndex > 0) playAyah(currentIndex - 1);
        };

        audio.addEventListener('play', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
        });
        audio.addEventListener('pause', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
        });
        audio.addEventListener('timeupdate', () => {
            // يمكن إضافة تحديث شريط التقدم هنا
        });

        // ========== العودة للرئيسية ==========
        window.goHome = function() {
            homeDiv.style.display = 'block';
            readerDiv.style.display = 'none';
            audio.pause();
            audio.src = '';
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
            playerDiv.classList.add('hidden');
            ayahs = [];
            currentIndex = 0;
        };

        // ========== مشاركة السورة ==========
        window.shareSurah = function() {
            const name = surahNameDiv.querySelector('span:first-child').innerText.replace('سورة', '').trim();
            if (navigator.share) {
                navigator.share({ title: `سورة ${name}`, text: `أقرأ سورة ${name} من القرآن الكريم`, url: window.location.href });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showNotification('تم نسخ الرابط');
            }
        };

        // ========== تغيير حجم الخط ==========
        window.changeFontSize = function(delta) {
            fontSize = Math.min(50, Math.max(20, fontSize + delta));
            localStorage.setItem('fontSize', fontSize);
            document.documentElement.style.setProperty('--font-size-base', fontSize + 'px');
        };
        // تطبيق الحجم المحفوظ
        document.documentElement.style.setProperty('--font-size-base', fontSize + 'px');

        // ========== البحث مع debounce ==========
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const q = searchInput.value.trim().toLowerCase();
                if (!q) { displaySurahs(allSurahs); return; }
                const filtered = allSurahs.filter(s => s.name.includes(q) || s.englishName.toLowerCase().includes(q));
                displaySurahs(filtered);
            }, 300);
        });

        // ========== زر العودة للأعلى ==========
        window.addEventListener('scroll', () => {
            goTopBtn.classList.toggle('show', window.scrollY > 300);
        });

        // ========== بدء التطبيق ==========
        loadSurahs();
    </script>
</body>
</html>
