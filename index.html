<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القرآن الكريم - المصحف الأخضر</title>
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    <!-- أيقونات Font Awesome للبحث والأزرار -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Amiri Quran', serif;
            background: #0a3b2e; /* أخضر داكن */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M20 20 L30 10 L40 20 L50 5 L60 20 L70 8 L80 20 L85 15 L90 20 L82 35 L90 50 L80 60 L70 50 L60 70 L50 55 L40 70 L30 55 L20 70 L10 50 L20 35 L10 20 L20 20" fill="none" stroke="%23e6d5a8" stroke-width="1.5"/><circle cx="50" cy="30" r="2" fill="%23e6d5a8"/><circle cx="30" cy="50" r="2" fill="%23e6d5a8"/><circle cx="70" cy="50" r="2" fill="%23e6d5a8"/></svg>');
            background-repeat: repeat;
            min-height: 100vh;
            padding-bottom: 140px;
            color: #f9f3d9;
            position: relative;
        }

        /* طبقة شفافة لتحسين القراءة */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 59, 46, 0.85);
            z-index: -1;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            font-size: 42px;
            color: #e6d5a8;
            text-shadow: 0 0 15px #2a6b4e, 2px 2px 0 #1d4a38;
            letter-spacing: 2px;
            background: linear-gradient(180deg, #1d5e45, transparent);
            border-bottom: 3px solid #c4a55b;
            position: relative;
        }

        header i {
            margin-left: 15px;
            color: #e6d5a8;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        /* مربع البحث */
        .search-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 2px solid #2a6b4e;
            border-radius: 60px;
            padding: 5px 20px;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0, 20, 10, 0.6);
        }

        .search-box i {
            font-size: 24px;
            color: #c4a55b;
            margin-left: 15px;
        }

        .search-box input {
            background: transparent;
            border: none;
            width: 100%;
            padding: 15px 0;
            font-size: 22px;
            color: #f9f3d9;
            outline: none;
            font-family: 'Amiri Quran', serif;
        }

        .search-box input::placeholder {
            color: #a1c9b6;
            opacity: 0.8;
        }

        /* زخرفة عنوان القائمة */
        .list-header {
            text-align: center;
            margin: 40px 0 25px;
            position: relative;
        }

        .list-header h2 {
            font-size: 36px;
            color: #e6d5a8;
            background: rgba(26, 78, 58, 0.7);
            display: inline-block;
            padding: 10px 40px;
            border-radius: 80px;
            border: 2px solid #c4a55b;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px #1a3b2c;
        }

        /* قائمة السور */
        #home {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .surah-card {
            background: rgba(26, 68, 50, 0.7);
            backdrop-filter: blur(8px);
            border: 2px solid #2a6b4e;
            color: #f3e8c2;
            padding: 20px 25px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.4s;
            box-shadow: 0 8px 20px rgba(0, 20, 0, 0.6);
            border-bottom: 4px solid #c4a55b;
        }

        .surah-card:hover {
            transform: translateY(-5px) scale(1.01);
            background: rgba(36, 94, 70, 0.9);
            border-color: #e6d5a8;
            box-shadow: 0 15px 35px #1a4a33;
        }

        .surah-name {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .surah-name i {
            color: #c4a55b;
            font-size: 28px;
        }

        .surah-number {
            background: #2a6b4e;
            color: #e6d5a8;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 22px;
            font-weight: bold;
            border: 2px solid #c4a55b;
            box-shadow: 0 0 0 2px #1d4a38;
        }

        /* صفحة المصحف */
        .mushaf {
            background: #fef9e7; /* ورق قديم فاتح */
            padding: 50px 30px;
            border-radius: 50px 50px 30px 30px;
            line-height: 3;
            font-size: 32px;
            text-align: center;
            box-shadow: 
                0 0 0 8px #2a6b4e,
                0 0 0 15px #c4a55b,
                0 25px 50px rgba(0, 30, 10, 0.8);
            color: #1d3b2c;
            position: relative;
            margin-top: 25px;
            background-image: radial-gradient(circle at 20% 30%, rgba(200, 180, 120, 0.1) 2%, transparent 3%),
                              radial-gradient(circle at 80% 70%, rgba(150, 120, 70, 0.1) 1%, transparent 2%);
            background-size: 50px 50px;
        }

        /* زخارف إسلامية حول المصحف */
        .mushaf::before {
            content: "﴿";
            font-size: 70px;
            color: #2a6b4e;
            position: absolute;
            top: -25px;
            right: 30px;
            opacity: 0.5;
            transform: rotate(10deg);
        }

        .mushaf::after {
            content: "﴾";
            font-size: 70px;
            color: #2a6b4e;
            position: absolute;
            bottom: -25px;
            left: 30px;
            opacity: 0.5;
            transform: rotate(-10deg);
        }

        .ayah {
            padding: 6px 12px;
            border-radius: 25px;
            transition: 0.3s;
            cursor: pointer;
            display: inline-block;
            margin: 2px 0;
        }

        .ayah:hover {
            background: rgba(42, 107, 78, 0.2);
        }

        .active {
            background: linear-gradient(145deg, #c4a55b, #2a6b4e);
            color: #fef9e7;
            box-shadow: 0 0 25px #c4a55b, 0 5px 15px #1d4a38;
            transform: scale(1.02);
            font-weight: bold;
            border-radius: 35px;
            padding: 6px 20px;
        }

        /* شريط اختيار القارئ والرجوع */
        .reader-header {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            background: rgba(26, 68, 50, 0.6);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 70px;
            border: 2px solid #c4a55b;
        }

        .back {
            background: #2a6b4e;
            border: 2px solid #c4a55b;
            padding: 12px 25px;
            border-radius: 50px;
            color: #f3e8c2;
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back i {
            font-size: 24px;
        }

        .back:hover {
            background: #1d5e45;
            transform: translateX(-5px);
        }

        .select {
            flex: 1;
            padding: 15px 25px;
            border-radius: 60px;
            border: 2px solid #c4a55b;
            font-size: 22px;
            background: #1d4a38;
            color: #f9f3d9;
            outline: none;
            cursor: pointer;
            font-family: 'Amiri Quran', serif;
        }

        .select option {
            background: #0a3b2e;
        }

        .surah-info {
            text-align: center;
            color: #e6d5a8;
            font-size: 40px;
            margin: 10px 0 5px;
            text-shadow: 0 0 10px #1a4a33;
        }

        /* المشغل */
        .player {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 700px;
            background: rgba(10, 45, 35, 0.95);
            backdrop-filter: blur(15px);
            border: 3px solid #c4a55b;
            border-radius: 80px;
            padding: 18px 30px;
            display: flex;
            justify-content: center;
            gap: 35px;
            box-shadow: 0 20px 45px #0a251d, 0 0 0 3px #2a6b4e inset;
            z-index: 1000;
            transition: 0.4s;
        }

        .player.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(30px);
        }

        .player button {
            background: linear-gradient(145deg, #c4a55b, #2a6b4e);
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 32px;
            cursor: pointer;
            transition: 0.3s;
            color: #1d3b2c;
            box-shadow: 0 8px 0 #1a4a33, 0 10px 20px black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 0 #1a4a33, 0 15px 25px black;
        }

        .player button:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #1a4a33, 0 10px 20px black;
        }

        .player button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: 0 4px 0 #1a4a33;
        }

        /* رسائل وحالات */
        .loader, .error {
            text-align: center;
            padding: 40px;
            font-size: 28px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50px;
            margin: 30px 0;
        }

        .loader {
            color: #e6d5a8;
        }

        .loader i {
            animation: spin 2s infinite linear;
            margin-left: 10px;
        }

        .error {
            color: #ffaa7a;
            border: 3px solid #c47a5b;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* زخارف إضافية */
        .islamic-pattern {
            height: 15px;
            background: repeating-linear-gradient(45deg, #c4a55b 0px, #c4a55b 10px, #2a6b4e 10px, #2a6b4e 20px);
            border-radius: 10px;
            margin: 20px 0;
        }

        /* تصميم متجاوب */
        @media (max-width: 700px) {
            header { font-size: 34px; }
            .surah-name { font-size: 22px; }
            .surah-number { width: 40px; height: 40px; font-size: 18px; }
            .mushaf { font-size: 26px; padding: 30px 15px; }
            .player button { width: 55px; height: 55px; font-size: 26px; }
            .select { font-size: 18px; }
        }
    </style>
</head>
<body>
    <header>
        <i class="fas fa-mosque"></i> القرآن الكريم <i class="fas fa-star"></i>
    </header>

    <div class="container">
        <!-- قسم البحث (يظهر في الصفحة الرئيسية) -->
        <div id="home">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن سورة... (مثل: البقرة، يس، الرحمن)">
            </div>
            <div class="list-header">
                <h2><i class="fas fa-list"></i> فهرس السور</h2>
            </div>
            <div id="surahList"></div> <!-- هنا تظهر البطاقات -->
        </div>

        <!-- صفحة عرض السورة -->
        <div id="reader" style="display: none;">
            <div class="reader-header">
                <button class="back" onclick="goHome()"><i class="fas fa-arrow-right"></i> العودة</button>
                <select class="select" id="reciter">
                    <option value="ar.alafasy">مشاري العفاسي</option>
                    <option value="ar.abdulbasitmurattal">عبد الباسط عبد الصمد - مرتل</option>
                    <option value="ar.mahermuaiqly">ماهر المعيقلي</option>
                    <option value="ar.ahmedajamy">أحمد العجمي</option>
                </select>
            </div>

            <div class="surah-info" id="surahName"></div>
            <div class="islamic-pattern"></div>

            <div class="mushaf" id="ayahContainer">
                <div class="loader"><i class="fas fa-spinner"></i> جاري تحميل السورة...</div>
            </div>
        </div>
    </div>

    <!-- مشغل الصوت -->
    <div class="player" id="player">
        <button onclick="prevAyah()" id="prevBtn" title="الآية السابقة"><i class="fas fa-step-backward"></i></button>
        <button onclick="togglePlay()" id="playPauseBtn" title="تشغيل/إيقاف"><i class="fas fa-play"></i></button>
        <button onclick="nextAyah()" id="nextBtn" title="الآية التالية"><i class="fas fa-step-forward"></i></button>
        <audio id="audio" preload="auto"></audio>
    </div>

    <script>
        // الثوابت
        const API = "https://api.alquran.cloud/v1";
        let allSurahs = [];          // جميع السور (للبحث)
        let ayahs = [];
        let currentIndex = 0;
        let currentSurahNumber = null;
        let isPlaying = false;

        // عناصر DOM
        const homeDiv = document.getElementById("home");
        const readerDiv = document.getElementById("reader");
        const surahListDiv = document.getElementById("surahList");
        const ayahContainer = document.getElementById("ayahContainer");
        const audio = document.getElementById("audio");
        const playerDiv = document.getElementById("player");
        const surahNameDiv = document.getElementById("surahName");
        const playPauseBtn = document.getElementById("playPauseBtn");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const searchInput = document.getElementById("searchInput");

        // تحميل جميع السور عند البدء
        async function loadSurahs() {
            try {
                surahListDiv.innerHTML = '<div class="loader"><i class="fas fa-spinner fa-spin"></i> جاري تحميل قائمة السور...</div>';
                
                const response = await fetch(`${API}/surah`);
                if (!response.ok) throw new Error("فشل الاتصال");
                
                const data = await response.json();
                allSurahs = data.data;
                displaySurahs(allSurahs);  // عرض الكل
            } catch (error) {
                surahListDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> حدث خطأ: ${error.message}</div>`;
            }
        }

        // عرض السور (مع إمكانية التصفية)
        function displaySurahs(surahsArray) {
            surahListDiv.innerHTML = "";
            if (surahsArray.length === 0) {
                surahListDiv.innerHTML = '<div class="error">لا توجد نتائج مطابقة</div>';
                return;
            }

            surahsArray.forEach(surah => {
                const card = document.createElement("div");
                card.className = "surah-card";
                card.setAttribute("data-surah-number", surah.number);
                card.innerHTML = `
                    <div class="surah-name">
                        <i class="fas fa-quran"></i>
                        <span>${surah.name} (${surah.englishName})</span>
                    </div>
                    <span class="surah-number">${surah.number}</span>
                `;
                card.onclick = () => openSurah(surah.number, surah.name);
                surahListDiv.appendChild(card);
            });
        }

        // فلترة السور حسب النص المدخل
        function filterSurahs() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                displaySurahs(allSurahs);
                return;
            }

            const filtered = allSurahs.filter(surah => 
                surah.name.includes(query) || 
                surah.englishName.toLowerCase().includes(query) ||
                surah.englishNameTranslation.toLowerCase().includes(query)
            );
            displaySurahs(filtered);
        }

        // فتح سورة
        async function openSurah(surahNumber, surahName) {
            try {
                homeDiv.style.display = "none";
                readerDiv.style.display = "block";
                surahNameDiv.textContent = `سورة ${surahName}`;
                ayahContainer.innerHTML = '<div class="loader"><i class="fas fa-spinner fa-spin"></i> جاري تحميل آيات السورة...</div>';
                playerDiv.classList.add("hidden");

                const response = await fetch(`${API}/surah/${surahNumber}/quran-uthmani`);
                if (!response.ok) throw new Error("فشل تحميل السورة");

                const data = await response.json();
                ayahs = data.data.ayahs;
                currentSurahNumber = surahNumber;
                currentIndex = 0;

                renderAyahs();
                playerDiv.classList.remove("hidden");
                updateButtonsState();

            } catch (error) {
                ayahContainer.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> ${error.message}</div>`;
            }
        }

        // عرض الآيات
        function renderAyahs() {
            ayahContainer.innerHTML = "";
            ayahs.forEach((ayah, i) => {
                const span = document.createElement("span");
                span.className = "ayah";
                span.id = `ayah-${i}`;
                span.textContent = ayah.text + " ۝ ";
                span.onclick = () => playAyah(i);
                ayahContainer.appendChild(span);
            });
            if (ayahs.length > 0) highlightAyah();
        }

        // تشغيل آية
        async function playAyah(index) {
            if (index < 0 || index >= ayahs.length) return;
            currentIndex = index;
            highlightAyah();

            try {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;

                const reciter = document.getElementById("reciter").value;
                const ayahNumber = ayahs[index].number;
                const response = await fetch(`${API}/ayah/${ayahNumber}/${reciter}`);
                if (!response.ok) throw new Error("فشل تحميل الصوت");

                const data = await response.json();
                audio.src = data.data.audio;
                await audio.play();

                audio.onended = () => {
                    if (currentIndex < ayahs.length - 1) {
                        playAyah(currentIndex + 1);
                    } else {
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        isPlaying = false;
                    }
                };

            } catch (error) {
                console.error(error);
                alert("تعذر تشغيل الصوت");
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            }
        }

        // تمييز الآية الحالية
        function highlightAyah() {
            document.querySelectorAll(".ayah").forEach(a => a.classList.remove("active"));
            const current = document.getElementById(`ayah-${currentIndex}`);
            if (current) {
                current.classList.add("active");
                current.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            updateButtonsState();
        }

        // تحديث حالة الأزرار
        function updateButtonsState() {
            if (!ayahs.length) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            prevBtn.disabled = (currentIndex === 0);
            nextBtn.disabled = (currentIndex === ayahs.length - 1);
        }

        // تشغيل/إيقاف
        function togglePlay() {
            if (!ayahs.length) return;
            if (audio.paused) {
                if (!audio.src) {
                    playAyah(currentIndex);
                } else {
                    audio.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                }
            } else {
                audio.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            }
        }

        // التالي
        function nextAyah() {
            if (currentIndex < ayahs.length - 1) playAyah(currentIndex + 1);
        }

        // السابق
        function prevAyah() {
            if (currentIndex > 0) playAyah(currentIndex - 1);
        }

        // العودة للرئيسية
        function goHome() {
            homeDiv.style.display = "block";
            readerDiv.style.display = "none";
            audio.pause();
            audio.src = "";
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
            playerDiv.classList.add("hidden");
            ayahs = [];
            currentIndex = 0;
        }

        // تحديث الأزرار كلما تغيرت الآية
        audio.addEventListener('play', () => { playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; isPlaying = true; });
        audio.addEventListener('pause', () => { playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; isPlaying = false; });
        audio.addEventListener('ended', () => { /* handled in playAyah */ });

        // البحث المباشر
        searchInput.addEventListener('input', filterSurahs);

        // بدء التطبيق
        loadSurahs();

        // معالجة الأخطار العامة
        window.addEventListener('error', (e) => console.error('Global error:', e.error));
    </script>
</body>
</html>
